---
- name: reliability-view-pcf-product
  tags: ((tags))
  icon: amazon-drive
  type: s3
  source:
    <<: *s3_env
    bucket: ((buckets_pivnet_products))
    regexp: reliability-view-pcf-product/\[reliability_view_pcf,(.*)\]reliability-view-.*.pivotal
- name: reliability-view-pas-exporter-product
  tags: ((tags))
  icon: amazon-drive
  type: s3
  source:
    <<: *s3_env
    bucket: ((buckets_pivnet_products))
    regexp: reliability-view-pas-exporter-product/\[reliability_view_pcf,(.*)\]reliability-view-pas-exporter-.*.pivotal
- name: reliability-view-pcf-stemcell
  tags: ((tags))
  icon: amazon-drive
  type: s3
  source:
    <<: *s3_env
    bucket: ((buckets_pivnet_products))
    regexp: reliability-view-pcf-stemcell/\[stemcells-ubuntu-xenial,(.*)\]bosh-stemcell-.*-azure.*\.tgz

- name: reliability-view-pas-exporter-stemcell
  tags: ((tags))
  icon: amazon-drive
  type: s3
  source:
    <<: *s3_env
    bucket: ((buckets_pivnet_products))
    regexp: reliability-view-pas-exporter-stemcell/\[stemcells-ubuntu-xenial,(.*)\]bosh-stemcell-.*-azure.*\.tgz

###

- name: get-reliability-view-pas-exporter
  on_failure:
    put: notify
    tags: ((tags))
    params:
      <<: *slack_failed_param
  on_success:  
    put: notify
    tags: ((tags))
    params:
      <<: *slack_succeeded_param
  serial: true
  serial_groups: [ get-products ]
  plan:
  - put: notify
    tags: ((tags))
    params:
      <<: *slack_start_param
  - in_parallel:
    - get: after-midnight
      tags: ((tags))
      trigger: true
    - get: platform-automation-image
      tags: ((tags))
      params:
        unpack: true
    - get: platform-automation-tasks
      tags: ((tags))
      params:
        unpack: true
    - get: templates
      tags: ((tags))
  - task: interpolate-product-downloads
    tags: ((tags))
    <<: *interpolate-product-downloads
  - task: download-reliability-view-pas-exporter-product-and-stemcell
    tags: ((tags))
    image: platform-automation-image
    file: platform-automation-tasks/tasks/download-product.yml
    params:
      CONFIG_FILE: download-product-configs/((pas_version))/download-reliability-view-pas-exporter.yml
    input_mapping:
      config: interpolated-product-downloads
    output_mapping: {downloaded-stemcell: reliability-view-pas-exporter-stemcell}
  - in_parallel:
    - put: reliability-view-pas-exporter-product
      tags: ((tags))
      params:
        file: downloaded-product/*.pivotal
    - put: reliability-view-pas-exporter-stemcell
      tags: ((tags))
      params:
        file: reliability-view-pas-exporter-stemcell/*.tgz

- name: get-reliability-view-pcf
  on_failure:
    put: notify
    tags: ((tags))
    params:
      <<: *slack_failed_param
  on_success:  
    put: notify
    tags: ((tags))
    params:
      <<: *slack_succeeded_param
  serial: true
  serial_groups: [ get-products ]
  plan:
  - put: notify
    tags: ((tags))
    params:
      <<: *slack_start_param
  - in_parallel:
    - get: after-midnight
      tags: ((tags))
      trigger: true
    - get: platform-automation-image
      tags: ((tags))
      params:
        unpack: true
    - get: platform-automation-tasks
      tags: ((tags))
      params:
        unpack: true
    - get: templates
      tags: ((tags))
  - task: interpolate-product-downloads
    tags: ((tags))
    <<: *interpolate-product-downloads
  - task: download-reliability-view-pcf-product-and-stemcell
    tags: ((tags))
    image: platform-automation-image
    file: platform-automation-tasks/tasks/download-product.yml
    params:
      CONFIG_FILE: download-product-configs/((pas_version))/download-reliability-view-pcf.yml
    input_mapping:
      config: interpolated-product-downloads
    output_mapping: {downloaded-stemcell: reliability-view-pcf-stemcell}
  - in_parallel:
    - put: reliability-view-pcf-product
      tags: ((tags))
      params:
        file: downloaded-product/*.pivotal
    - put: reliability-view-pcf-stemcell
      tags: ((tags))
      params:
        file: reliability-view-pcf-stemcell/*.tgz


###
- name: upload-and-stage-reliability-view-pcf
  on_failure:
    put: notify
    tags: ((tags))
    params:
      <<: *slack_failed_param
  on_success:  
    put: notify
    tags: ((tags))
    params:
      <<: *slack_succeeded_param
  serial: true
  serial_groups:
  - apply
  - upload-and-stage
  - configure-products
  - get-products
  plan:
  - put: notify
    tags: ((tags))
    params:
      <<: *slack_start_param
  - in_parallel:
    - get: platform-automation-image
      tags: ((tags))
      params:
        unpack: true
      passed:
      - upgrade-opsman
    - get: platform-automation-tasks
      tags: ((tags))
      params:
        unpack: true
    - get: templates
      tags: ((tags))
    - get: variable
      tags: ((tags))
    - get: reliability-view-pcf-product
      tags: ((tags))      
      trigger: true     
    - get: reliability-view-pcf-stemcell
      tags: ((tags))      
      trigger: true     
  - task: interpolate-product-downloads
    tags: ((tags))
    <<: *interpolate-product-downloads
  - task: download-reliability-view-pcf
    tags: ((tags))
    image: platform-automation-image
    file: platform-automation-tasks/tasks/download-product-s3.yml
    params:
      CONFIG_FILE: download-product-configs/((pas_version))/download-reliability-view-pcf.yml
    input_mapping:
      config: interpolated-product-downloads
    output_mapping:
      downloaded-product: reliability-view-pcf-product
      downloaded-stemcell: reliability-view-pcf-stemcell
  - task: upload-product
    tags: ((tags))
    image: platform-automation-image
    file: platform-automation-tasks/tasks/upload-product.yml
    input_mapping:
      product: reliability-view-pcf-product
      env: variable
    params:
      ENV_FILE: ((foundation))/env/env.yml
  - task: upload-reliability-view-pcf-stemcell
    tags: ((tags))
    image: platform-automation-image
    file: platform-automation-tasks/tasks/upload-stemcell.yml
    input_mapping:
      env: variable
      stemcell: reliability-view-pcf-stemcell
    params:
      ENV_FILE: ((foundation))/env/env.yml
  - task: stage-product
    tags: ((tags))
    image: platform-automation-image
    file: platform-automation-tasks/tasks/stage-product.yml
    input_mapping:
      product: reliability-view-pcf-product
      env: variable
    params:
      ENV_FILE: ((foundation))/env/env.yml  

- name: upload-and-stage-reliability-view-pas-exporter
  on_failure:
    put: notify
    tags: ((tags))
    params:
      <<: *slack_failed_param
  on_success:  
    put: notify
    tags: ((tags))
    params:
      <<: *slack_succeeded_param
  serial: true
  serial_groups:
  - apply
  - upload-and-stage
  - configure-products
  - get-products
  plan:
  - put: notify
    tags: ((tags))
    params:
      <<: *slack_start_param
  - in_parallel:
    - get: platform-automation-image
      tags: ((tags))
      params:
        unpack: true
      passed:
      - upgrade-opsman
    - get: platform-automation-tasks
      tags: ((tags))
      params:
        unpack: true
    - get: templates
      tags: ((tags))
    - get: variable
      tags: ((tags))
    - get: reliability-view-pas-exporter-product
      tags: ((tags))      
      trigger: true     
    - get: reliability-view-pas-exporter-stemcell
      tags: ((tags))      
      trigger: true     
  - task: interpolate-product-downloads
    tags: ((tags))
    <<: *interpolate-product-downloads
  - task: download-reliability-view-pas-exporter
    tags: ((tags))
    image: platform-automation-image
    file: platform-automation-tasks/tasks/download-product-s3.yml
    params:
      CONFIG_FILE: download-product-configs/((pas_version))/download-reliability-view-pas-exporter.yml
    input_mapping:
      config: interpolated-product-downloads
    output_mapping:
      downloaded-product: reliability-view-pas-exporter-product
      downloaded-stemcell: reliability-view-pas-exporter-stemcell
  - task: upload-product
    tags: ((tags))
    image: platform-automation-image
    file: platform-automation-tasks/tasks/upload-product.yml
    input_mapping:
      product: reliability-view-pas-exporter-product
      env: variable
    params:
      ENV_FILE: ((foundation))/env/env.yml
  - task: upload-reliability-view-pas-exporter-stemcell
    tags: ((tags))
    image: platform-automation-image
    file: platform-automation-tasks/tasks/upload-stemcell.yml
    input_mapping:
      env: variable
      stemcell: reliability-view-pas-exporter-stemcell
    params:
      ENV_FILE: ((foundation))/env/env.yml
  - task: stage-product
    tags: ((tags))
    image: platform-automation-image
    file: platform-automation-tasks/tasks/stage-product.yml
    input_mapping:
      product: reliability-view-pas-exporter-product
      env: variable
    params:
      ENV_FILE: ((foundation))/env/env.yml  

###
- name: configure-reliability-view-pcf
  on_failure:
    put: notify
    tags: ((tags))
    params:
      <<: *slack_failed_param
  on_success:  
    put: notify
    tags: ((tags))
    params:
      <<: *slack_succeeded_param
  serial_groups:
  - apply
  - configure-products
  serial: true
  plan:
  - put: notify
    tags: ((tags))
    params:
      <<: *slack_start_param
  - in_parallel:
    - get: platform-automation-image
      tags: ((tags))
      params:
        unpack: true
      passed:
        - upload-and-stage-reliability-view-pcf
      trigger: true
    - get: platform-automation-tasks
      tags: ((tags))
      params:
        unpack: true
    - get: templates
      tags: ((tags))
    - get: variable
      tags: ((tags))
  - task: interpolate-product-templates
    tags: ((tags))
    <<: *interpolate-product-templates
  - task: configure-reliability-view-pcf
    tags: ((tags))
    image: platform-automation-image
    file: platform-automation-tasks/tasks/configure-product.yml
    input_mapping:
      config: interpolated-product-templates
      env: variable
      vars: variable
    params:
      CONFIG_FILE: product-configs/((pas_version))/reliability-view-pcf.yml
      VARS_FILES: vars/((foundation))/vars/reliability-view-pcf-vars.yml
      ENV_FILE: ((foundation))/env/env.yml 

- name: configure-reliability-view-pas-exporter
  on_failure:
    put: notify
    tags: ((tags))
    params:
      <<: *slack_failed_param
  on_success:  
    put: notify
    tags: ((tags))
    params:
      <<: *slack_succeeded_param
  serial_groups:
  - apply
  - configure-products
  serial: true
  plan:
  - put: notify
    tags: ((tags))
    params:
      <<: *slack_start_param
  - in_parallel:
    - get: platform-automation-image
      tags: ((tags))
      params:
        unpack: true
      passed:
        - upload-and-stage-reliability-view-pas-exporter
      trigger: true
    - get: platform-automation-tasks
      tags: ((tags))
      params:
        unpack: true
    - get: templates
      tags: ((tags))
    - get: variable
      tags: ((tags))
  - task: interpolate-product-templates
    tags: ((tags))
    <<: *interpolate-product-templates
  - task: configure-reliability-view-pas-exporter
    tags: ((tags))
    image: platform-automation-image
    file: platform-automation-tasks/tasks/configure-product.yml
    input_mapping:
      config: interpolated-product-templates
      env: variable
      vars: variable
    params:
      CONFIG_FILE: product-configs/((pas_version))/reliability-view-pas-exporter.yml
      VARS_FILES: vars/((foundation))/vars/reliability-view-pas-exporter-vars.yml
      ENV_FILE: ((foundation))/env/env.yml 

###
- name: staged-reliability-view-pcf-config
  on_failure:
    put: notify
    tags: ((tags))
    params:
      <<: *slack_failed_param
  on_success:  
    put: notify
    tags: ((tags))
    params:
      <<: *slack_succeeded_param
  serial_groups:
  - staged-configs
  plan:
  - put: notify
    tags: ((tags))
    params:
      <<: *slack_start_param
  - in_parallel:
      <<: *stage_steps
  - task: staged-config
    tags: ((tags))
    <<: *stage_config
    params:
      PRODUCT_NAME: p-reliability-view
      ENV_FILE: ((foundation))/env/env.yml
      SUBSTITUTE_CREDENTIALS_WITH_PLACEHOLDERS: false
    ensure: #&make-config-commit
      do:
        - task: make-commit
          tags: ((tags))
          <<: *do_stage_commit
          params:
            FILE_SOURCE_PATH: p-reliability-view.yml
            FILE_DESTINATION_PATH: ((foundation))/config/p-reliability-view.yml
            <<: *git_commit_env
        - put: variable
          tags: ((tags))
          params:
            repository: variable-commit
            merge: true  

- name: staged-reliability-view-pas-exporter-config
  on_failure:
    put: notify
    tags: ((tags))
    params:
      <<: *slack_failed_param
  on_success:  
    put: notify
    tags: ((tags))
    params:
      <<: *slack_succeeded_param
  serial_groups:
  - staged-configs
  plan:
  - put: notify
    tags: ((tags))
    params:
      <<: *slack_start_param
  - in_parallel:
      <<: *stage_steps
  - task: staged-config
    tags: ((tags))
    <<: *stage_config
    params:
      PRODUCT_NAME: p-reliability-view-pas-exporter
      ENV_FILE: ((foundation))/env/env.yml
      SUBSTITUTE_CREDENTIALS_WITH_PLACEHOLDERS: false
    ensure: #&make-config-commit
      do:
        - task: make-commit
          tags: ((tags))
          <<: *do_stage_commit
          params:
            FILE_SOURCE_PATH: p-reliability-view-pas-exporter.yml
            FILE_DESTINATION_PATH: ((foundation))/config/p-reliability-view-pas-exporter.yml
            <<: *git_commit_env
        - put: variable
          tags: ((tags))
          params:
            repository: variable-commit
            merge: true              


